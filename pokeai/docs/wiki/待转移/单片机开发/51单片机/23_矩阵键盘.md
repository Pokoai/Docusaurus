---
position: 4
---

```c

// 头文件
#include <reg52.h>

// 类型重定义
typedef unsigned char u8;
typedef unsigned int u16;

// 管脚定义
#define LED P0  
#define KEY P1


// ms 延时函数
static void delay_ms(u16 n)
{
    n *= 23;
    while (n--);
}

// 4*4矩阵键盘扫描函数
u8 key_scan()
{
    u8 key_num;

    // 不像独立按键一端接 IO 口，一端接地
    // 矩阵键盘两端都接在 IO 口上，所以必须软件模拟地
    KEY = 0x0F;  // 高四位为地
    if ( KEY != 0x0F ) {
        delay_ms(5);
        if ( KEY != 0x0F ) {
            // 扫描列
            KEY = 0x0F;
            switch (KEY) {
                case 0x07: key_num = 1; break;  // 第一列
                case 0x0B: key_num = 2; break;
                case 0x0D: key_num = 3; break;
                case 0x0E: key_num = 4; break;
            }
            KEY = 0xF0;  // 扫描行
            switch ( GPIO_KEY ) {
                case 0x70: key_num += 0;  break;  // 第一行
                case 0xB0: key_num += 4;  break;
                case 0xD0: key_num += 8;  break;
                case 0xE0: key_num += 12; break;
            }
            // 松手检测，但是不会一直卡在这里面，50ms到了软件模拟自动释放
            while ( (t++ < 50) && KEY != 0xF0 ) {
                delay_ms(1);
            }
        }
    }

    return key_num;
}


void main()
{   
    u8 key_num;

    while (1) {
        key_num = key_scan();
        ......
    }
}

```